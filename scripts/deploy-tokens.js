const { createWalletClient, createPublicClient, http, parseEther } = require('viem');
const { privateKeyToAccount } = require('viem/accounts');
const { defineChain } = require('viem');

// Coston2 chain definition
const coston2 = defineChain({
  id: 114,
  name: 'Coston2',
  network: 'coston2',
  nativeCurrency: {
    decimals: 18,
    name: 'Coston2 Flare',
    symbol: 'C2FLR',
  },
  rpcUrls: {
    default: {
      http: ['https://coston2-api.flare.network/ext/C/rpc'],
    },
    public: {
      http: ['https://coston2-api.flare.network/ext/C/rpc'],
    },
  },
  blockExplorers: {
    default: { name: 'Coston2 Explorer', url: 'https://coston2-explorer.flare.network' },
  },
});

// Simple ERC20 bytecode (compiled TestToken)
const TOKEN_BYTECODE = '0x608060405234801561001057600080fd5b5060405161098338038061098383398101604081905261002f916101ab565b600061003b84826102a4565b50600161004883826102a4565b506002805460ff191660ff929092169190911790555061036392505050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261008e57600080fd5b81516001600160401b03808211156100a8576100a8610067565b604051601f8301601f19908116603f011681019082821181831017156100d0576100d0610067565b816040528381526020925086838588010111156100ec57600080fd5b600091505b8382101561010e57858201830151818301840152908201906100f1565b600093810190920192909252949350505050565b805160ff8116811461013357600080fd5b919050565b60008060006060848603121561014d57600080fd5b83516001600160401b038082111561016457600080fd5b6101708783880161007d565b9450602086015191508082111561018657600080fd5b506101938682870161007d565b9250506101a260408501610122565b90509250925092565b6000806000606084860312156101c057600080fd5b83516001600160401b03808211156101d757600080fd5b6101e38783880161007d565b945060208601519150808211156101f957600080fd5b506102068682870161007d565b925050604084015160ff8116811461021d57600080fd5b809150509250925092565b600181811c9082168061023c57607f821691505b60208210810361025c57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561029f57600081815260208120601f850160051c8101602086101561028957508054838255610295565b600082815260208120601f850160051c8301915b818110156102b857828155848201915061029b565b505050505050565b505050565b81516001600160401b038111156102de576102de610067565b6102f2816102ec8454610228565b84610262565b602080601f831160018114610327576000841561030f5750858301515b600019600386901b1c1916600185901b1785556102b0565b600085815260208120601f198616915b8281101561035657888601518255948401946001909101908401610337565b50858210156103745787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b610611806103726000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806340c10f191161007157806340c10f191461012957806370a082311461013e57806395d89b4114610167578063a9059cbb1461016f578063dd62ed3e14610182578063313ce567146101bb57600080fd5b806306fdde03146100ae578063095ea7b3146100cc57806318160ddd146100ef57806323b872dd14610106578063313ce56714610119575b600080fd5b6100b66101d6565b6040516100c391906104a8565b60405180910390f35b6100df6100da3660046104f6565b610264565b60405190151581526020016100c3565b6100f860035481565b6040519081526020016100c3565b6100df610114366004610520565b6102d1565b60025460405160ff90911681526020016100c3565b61013c6101373660046104f6565b610383565b005b6100f861014c36600461055c565b6001600160a01b031660009081526004602052604090205490565b6100b66103e2565b6100df61017d3660046104f6565b6103ef565b6100f861019036600461057e565b6001600160a01b03918216600090815260056020908152604080832093909416825291909152205490565b6002546101c89060ff1681565b60405160ff90911681526020016100c3565b600080546101e3906105b1565b80601f016020809104026020016040519081016040528092919081815260200182805461020f906105b1565b801561025c5780601f106102315761010080835404028352916020019161025c565b820191906000526020600020905b81548152906001019060200180831161023f57829003601f168201915b505050505081565b3360008181526005602090815260408083206001600160a01b038716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925906102bf9086815260200190565b60405180910390a35060015b92915050565b6001600160a01b038316600090815260056020908152604080832033845290915281208054839190610304908490610601565b90915550506001600160a01b03841660009081526004602052604081208054849290610331908490610601565b90915550506001600160a01b0383166000908152600460205260408120805484929061035e908490610614565b90915550506040518281526001600160a01b0384169033906000805160206105bc8339815191529060200160405180910390a35060019392505050565b80600360008282546103ad9190610614565b90915550506001600160a01b0382166000818152600460209081526040808320805486019055518481526000805160206105bc833981519152910160405180910390a35050565b600180546101e3906105b1565b336000908152600460205260408120805483919061040e908490610601565b90915550506001600160a01b0382166000908152600460205260408120805484929061043b908490610614565b90915550506040518281526001600160a01b038316903390600080516020610bc88339815191529060200160405180910390a350600192915050565b60005b8381101561049357818101518382015260200161047b565b838111156104a2576000848401525b50505050565b60208152600082518060208401526104c7816040850160208701610478565b601f01601f19169190910160400192915050565b80356001600160a01b03811681146104f257600080fd5b919050565b6000806040838503121561050a57600080fd5b610513836104db565b946020939093013593505050565b60008060006060848603121561053657600080fd5b61053f846104db565b925061054d602085016104db565b9150604084013590509250925092565b60006020828403121561056f57600080fd5b610578826104db565b9392505050565b6000806040838503121561059257600080fd5b61059b836104db565b91506105a9602084016104db565b90509250929050565b600181811c908216806105c657607f821691505b6020821081036105e657634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052601160045260246000fd5b818103818111156102cb576102cb6105ec565b808201808211156102cb576102cb6105ec56feddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa264697066735822122035a18c0c07f8e43e0927a0c71bd6d0a5ae45e16a7c9a4fcaa8b80a458b8f8e1264736f6c63430008130033';

// ABI for constructor
const TOKEN_ABI = [
  {
    inputs: [
      { name: '_name', type: 'string' },
      { name: '_symbol', type: 'string' },
      { name: '_decimals', type: 'uint8' }
    ],
    stateMutability: 'nonpayable',
    type: 'constructor'
  },
  {
    inputs: [
      { name: 'to', type: 'address' },
      { name: 'amount', type: 'uint256' }
    ],
    name: 'mint',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function'
  }
];

async function main() {
  const privateKey = '0x19e1d43797e69038fba043ec7a5091c5a96a3e32fabce3eb96da1fa0b57e24ba';

  const account = privateKeyToAccount(privateKey);
  console.log('Deploying from address:', account.address);

  const publicClient = createPublicClient({
    chain: coston2,
    transport: http(),
  });

  const walletClient = createWalletClient({
    account,
    chain: coston2,
    transport: http(),
  });

  // Check balance
  const balance = await publicClient.getBalance({ address: account.address });
  console.log('Balance:', balance.toString(), 'wei');

  if (balance === 0n) {
    console.log('ERROR: No balance! Get C2FLR from https://faucet.flare.network/coston2');
    return;
  }

  // Encode constructor arguments for WFLR
  const { encodeAbiParameters } = require('viem');

  // Deploy WFLR
  console.log('\nDeploying WFLR...');
  const wflrArgs = encodeAbiParameters(
    [{ type: 'string' }, { type: 'string' }, { type: 'uint8' }],
    ['Wrapped Flare Test', 'WFLR', 18]
  );

  const wflrTx = await walletClient.deployContract({
    abi: TOKEN_ABI,
    bytecode: TOKEN_BYTECODE + wflrArgs.slice(2),
    args: ['Wrapped Flare Test', 'WFLR', 18],
  });
  console.log('WFLR deploy tx:', wflrTx);

  const wflrReceipt = await publicClient.waitForTransactionReceipt({ hash: wflrTx });
  console.log('WFLR deployed at:', wflrReceipt.contractAddress);

  // Deploy USDC
  console.log('\nDeploying USDC...');
  const usdcTx = await walletClient.deployContract({
    abi: TOKEN_ABI,
    bytecode: TOKEN_BYTECODE,
    args: ['USD Coin Test', 'USDC', 6],
  });
  console.log('USDC deploy tx:', usdcTx);

  const usdcReceipt = await publicClient.waitForTransactionReceipt({ hash: usdcTx });
  console.log('USDC deployed at:', usdcReceipt.contractAddress);

  console.log('\n=== DEPLOYMENT COMPLETE ===');
  console.log('WFLR:', wflrReceipt.contractAddress);
  console.log('USDC:', usdcReceipt.contractAddress);
}

main().catch(console.error);
