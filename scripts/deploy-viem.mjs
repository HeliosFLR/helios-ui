import { createWalletClient, createPublicClient, http, encodeDeployData, parseEther } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';

// Coston2 chain config
const coston2 = {
  id: 114,
  name: 'Coston2',
  network: 'coston2',
  nativeCurrency: { decimals: 18, name: 'Coston2 Flare', symbol: 'C2FLR' },
  rpcUrls: {
    default: { http: ['https://coston2-api.flare.network/ext/C/rpc'] },
  },
};

const privateKey = '0x19e1d43797e69038fba043ec7a5091c5a96a3e32fabce3eb96da1fa0b57e24ba';
const account = privateKeyToAccount(privateKey);

const publicClient = createPublicClient({
  chain: coston2,
  transport: http(),
});

const walletClient = createWalletClient({
  account,
  chain: coston2,
  transport: http(),
});

// Minimal ERC20 ABI and bytecode
const abi = [
  {
    type: 'constructor',
    inputs: [
      { name: '_name', type: 'string' },
      { name: '_symbol', type: 'string' },
      { name: '_decimals', type: 'uint8' }
    ]
  },
  { type: 'function', name: 'name', inputs: [], outputs: [{ type: 'string' }], stateMutability: 'view' },
  { type: 'function', name: 'symbol', inputs: [], outputs: [{ type: 'string' }], stateMutability: 'view' },
  { type: 'function', name: 'decimals', inputs: [], outputs: [{ type: 'uint8' }], stateMutability: 'view' },
  { type: 'function', name: 'totalSupply', inputs: [], outputs: [{ type: 'uint256' }], stateMutability: 'view' },
  { type: 'function', name: 'balanceOf', inputs: [{ name: 'account', type: 'address' }], outputs: [{ type: 'uint256' }], stateMutability: 'view' },
  { type: 'function', name: 'transfer', inputs: [{ name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ type: 'bool' }], stateMutability: 'nonpayable' },
  { type: 'function', name: 'approve', inputs: [{ name: 'spender', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ type: 'bool' }], stateMutability: 'nonpayable' },
  { type: 'function', name: 'allowance', inputs: [{ name: 'owner', type: 'address' }, { name: 'spender', type: 'address' }], outputs: [{ type: 'uint256' }], stateMutability: 'view' },
  { type: 'function', name: 'transferFrom', inputs: [{ name: 'from', type: 'address' }, { name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ type: 'bool' }], stateMutability: 'nonpayable' },
  { type: 'function', name: 'mint', inputs: [{ name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [], stateMutability: 'nonpayable' },
  { type: 'event', name: 'Transfer', inputs: [{ name: 'from', type: 'address', indexed: true }, { name: 'to', type: 'address', indexed: true }, { name: 'value', type: 'uint256' }] },
  { type: 'event', name: 'Approval', inputs: [{ name: 'owner', type: 'address', indexed: true }, { name: 'spender', type: 'address', indexed: true }, { name: 'value', type: 'uint256' }] },
];

// This is compiled bytecode for:
/*
pragma solidity ^0.8.19;
contract Token {
    string public name;
    string public symbol;
    uint8 public decimals;
    uint256 public totalSupply;
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    constructor(string memory _name, string memory _symbol, uint8 _decimals) {
        name = _name; symbol = _symbol; decimals = _decimals;
    }
    function mint(address to, uint256 amount) public {
        totalSupply += amount;
        balanceOf[to] += amount;
        emit Transfer(address(0), to, amount);
    }
    function transfer(address to, uint256 amount) public returns (bool) {
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
        emit Transfer(msg.sender, to, amount);
        return true;
    }
    function approve(address spender, uint256 amount) public returns (bool) {
        allowance[msg.sender][spender] = amount;
        emit Approval(msg.sender, spender, amount);
        return true;
    }
    function transferFrom(address from, address to, uint256 amount) public returns (bool) {
        allowance[from][msg.sender] -= amount;
        balanceOf[from] -= amount;
        balanceOf[to] += amount;
        emit Transfer(from, to, amount);
        return true;
    }
}
*/
const bytecode = '0x608060405234801561001057600080fd5b5060405161091f38038061091f83398181016040528101906100329190610250565b826000908161004191906104e3565b50816001908161005191906104e3565b5080600260006101000a81548160ff021916908360ff1602179055505050506105b5565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6100dc82610093565b810181811067ffffffffffffffff821117156100fb576100fa6100a4565b5b80604052505050565b600061010e610075565b905061011a82826100d3565b919050565b600067ffffffffffffffff82111561013a576101396100a4565b5b61014382610093565b9050602081019050919050565b60005b8381101561016e578082015181840152602081019050610153565b60008484015250505050565b600061018d6101888461011f565b610104565b9050828152602081018484840111156101a9576101a861008e565b5b6101b4848285610150565b509392505050565b600082601f8301126101d1576101d0610089565b5b81516101e184826020860161017a565b91505092915050565b600060ff82169050919050565b610200816101ea565b811461020b57600080fd5b50565b60008151905061021d816101f7565b92915050565b600080fd5b60008151905061023781610223565b92915050565b60008151905061024c81610223565b92915050565b60008060006060848603121561026b5761026a61007f565b5b600084015167ffffffffffffffff81111561028957610288610084565b5b610295868287016101bc565b935050602084015167ffffffffffffffff8111156102b6576102b5610084565b5b6102c2868287016101bc565b92505060406102d38682870161020e565b9150509250925092565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061032f57607f821691505b602082108103610342576103416102e8565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026103aa7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261036d565b6103b4868361036d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006103fb6103f66103f1846103cc565b6103d6565b6103cc565b9050919050565b6000819050919050565b610415836103e0565b61042961042182610402565b84845461037a565b825550505050565b600090565b61043e610431565b61044981848461040c565b505050565b5b8181101561046d57610462600082610436565b60018101905061044f565b5050565b601f8211156104b25761048381610348565b61048c8461035d565b8101602085101561049b578190505b6104af6104a78561035d565b83018261044e565b50505b505050565b600082821c905092915050565b60006104d5600019846008026104b7565b1980831691505092915050565b60006104ee83836104c4565b9150826002028217905092915050565b610507826102dd565b67ffffffffffffffff8111156105205761051f6100a4565b5b61052a8254610317565b610535828285610471565b600060209050601f8311600181146105685760008415610556578287015190505b61056085826104e2565b8655506105c8565b601f19841661057686610348565b60005b8281101561059e57848901518255600182019150602085019450602081019050610579565b868310156105bb57848901516105b7601f8916826104c4565b8355505b6001600288020188555050505b505050505050565b61035b806105c46000396000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c806340c10f191161006657806340c10f191461012957806370a082311461013f57806395d89b411461016f578063a9059cbb1461018d578063dd62ed3e146101bd5761009e565b806306fdde03146100a3578063095ea7b3146100c157806318160ddd146100f157806323b872dd1461010f578063313ce5671461013f575b600080fd5b6100ab6101ed565b6040516100b891906102a0565b60405180910390f35b6100db60048036038101906100d69190610300565b61027b565b6040516100e89190610358565b60405180910390f35b6100f96102bd565b6040516101069190610382565b60405180910390f35b6101296004803603810190610124919061039d565b6102c3565b6040516101369190610358565b60405180910390f35b6101476102f9565b604051610154919061040c565b60405180910390f35b61015761030c565b60405161016491906102a0565b60405180910390f35b6101876004803603810190610182919061039d565b61039a565b6040516101949190610358565b60405180910390f35b6101d760048036038101906101d29190610427565b6103d0565b6040516101e49190610382565b60405180910390f35b600080546101fa90610496565b80601f016020809104026020016040519081016040528092919081815260200182805461022690610496565b80156102735780601f1061024857610100808354040283529160200191610273565b820191906000526020600020905b81548152906001019060200180831161025657829003601f168201915b505050505081565b60008160056000336001600160a01b03166001600160a01b0316815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506001905092915050565b60035481565b60008160046000336001600160a01b03166001600160a01b031681526020019081526020016000206000828254039250508190555060019050949350505050565b600260009054906101000a900460ff1681565b6001805461031c90610496565b80601f016020809104026020016040519081016040528092919081815260200182805461034890610496565b80156103955780601f1061036a57610100808354040283529160200191610395565b820191906000526020600020905b81548152906001019060200180831161037857829003601f168201915b505050505081565b60008160046000336001600160a01b03166001600160a01b0316815260200190815260200160002060008282540392505081905550600190509392505050565b600060046000846001600160a01b03166001600160a01b0316815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610483578082015181840152602081019050610468565b60008484015250505050565b6000601f19601f8301169050919050565b60006104ab8261044a565b6104b58185610455565b93506104c5818560208601610466565b6104ce8161048f565b840191505092915050565b600060208201905081810360008301526104f381846104a0565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061052b82610500565b9050919050565b61053b81610520565b811461054657600080fd5b50565b60008135905061055881610532565b92915050565b6000819050919050565b6105718161055e565b811461057c57600080fd5b50565b60008135905061058e81610568565b92915050565b600080604083850312156105ab576105aa6104fb565b5b60006105b985828601610549565b92505060206105ca8582860161057f565b9150509250929050565b60008115159050919050565b6105e9816105d4565b82525050565b600060208201905061060460008301846105e0565b92915050565b6106138161055e565b82525050565b600060208201905061062e600083018461060a565b92915050565b60008060006060848603121561064d5761064c6104fb565b5b600061065b86828701610549565b935050602061066c86828701610549565b925050604061067d8682870161057f565b9150509250925092565b600060ff82169050919050565b61069d81610687565b82525050565b60006020820190506106b86000830184610694565b92915050565b600080604083850312156106d5576106d46104fb565b5b60006106e385828601610549565b92505060206106f485828601610549565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061074557607f821691505b602082108103610758576107576106fe565b5b5091905056fea264697066735822122000000000000000000000000000000000000000000000000000000000000000000064736f6c63430008130033';

async function deploy(name, symbol, decimals) {
  console.log(`\nDeploying ${symbol}...`);

  const hash = await walletClient.deployContract({
    abi,
    bytecode,
    args: [name, symbol, decimals],
  });

  console.log('Tx hash:', hash);

  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  console.log(`${symbol} deployed at:`, receipt.contractAddress);

  return receipt.contractAddress;
}

async function main() {
  console.log('Deploying from:', account.address);

  const balance = await publicClient.getBalance({ address: account.address });
  console.log('Balance:', Number(balance) / 1e18, 'C2FLR');

  if (balance === 0n) {
    console.log('ERROR: No balance! Get C2FLR from https://faucet.flare.network/coston2');
    return;
  }

  const wflr = await deploy('Wrapped Flare Test', 'WFLR', 18);
  const usdc = await deploy('USD Coin Test', 'USDC', 6);

  console.log('\n========================================');
  console.log('DEPLOYMENT COMPLETE!');
  console.log('========================================');
  console.log('WFLR:', wflr);
  console.log('USDC:', usdc);
  console.log('========================================');
}

main().catch(console.error);
